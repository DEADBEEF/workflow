{% extends 'base.html' %}
{% block title %}Site View{% endblock %}

{% block scripts %}
{% load staticfiles %}
<link rel="stylesheet" type="text/css" href="{% static "site.css" %}" />
<link type="text/css" href="{% static "jquery-ui.css" %}" rel="stylesheet" />
<script type="text/javascript" src="{% static "site.js" %}" ></script>
<script type="text/javascript" >
    var task_edges = eval('{{edges|safe}}');
{% if perms.web.edit_task %}
    var privelege = true;
{% endif %}
</script>
<script type="text/javascript" src="{% static "visual_site.js" %}" ></script>
{% endblock %}

{% block content %}
<div id="task_list">
    <h3>{{site.name}}</h3>
    <div id="wrapper" style="width:{{width}}px;height:{{height}}px;">
    <div id="workflow_vis" style="width:{{width }}px;height:{{height}}px">
        <div id="dialog" title="Confirmation Required">
            Are you sure you want to remove this dependency?
        </div>
        {% for node in nodes %}
        <div id="task{{node.id}}" class="taskNode draggable {{node.div_class}}"
            style="left:{{node.x}}px;top:{{node.y}}px;position:absolute;" >
            <a href="{% url web.views.task site=node.task.site.id task_id=node.id%}">
                {{node.task.job_type.name}}</a>
            <br/>
            {% if node.assigned %}
            <div class="user">{{node.task.assignee}}</div>
            {% else %}
            <div class="user">No user assigned</div>
            {% endif %}
            <div class="files">{{node.files}}</div>
            {% if perms.web.edit_task %}
            <a href="{% url web.views.edit_task site=node.task.site.id task_id=node.id%}">Edit</a>
            <div class="source"></div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    </div>
<form action="{% url web.views.run_task %}" method="post">{% csrf_token %}
 <input type="hidden" name="site" value="{{ site_id }}"/>
 <input type="hidden" name="next" value="{% url web.views.view_site site=site_id  %}"/>
 <button id="run_tasks" type="submit">Run Tasks</button>
</form>
 <table>
  <tr>
   <th class="tl">Name of task</th>
   {%if perms.web.edit_task %}<th>Edit</th>{% endif %}
   <th>Site</th>
   <th>Priority</th>
   <th>Category</th>
   <th>Assignee</th>
   <th class="tr">Status</th>
  </tr>
 {% for task in tasks %}
 <tr>
  <td><a href="{% url web.views.task site=task.site.id task_id=task.id %}">
   {{ task.job_type.name }}
  </a></td>
   {%if perms.web.edit_task %}
   <td class="center"><a href="{% url web.views.edit_task site=task.site.id task_id=task.id %}">
   Edit
  </a></td>{%endif%}
   <td class="center">{{ task.site }}</td>
   <td class="center" >{{ task.priority }}</td>
   <td class="center">{{ task.job_type.category }}</td>
   <td class="center">{{ task.assignee }}</td>
   <td class="center">{{ task.get_job_status_display }}</td>
  </tr>
 {% endfor %}
 </table>

{%if perms.web.edit_task %}
<div id="add_task">
 <button id="user_but" type="button">Add User Task</button>
 <button id="server_but" type="button">Add Server Task</button>
 <div id="user" class="hidden">
  <form action="{% url web.views.add_task %}" method="post">{%csrf_token%}
   <label for="id_job_type">Job:</label>
   {{ user_form.job_type }}
   <button type="submit">Create User Job</button>
   <input type="hidden", name="site_id" value="{{site_id}}"/>
  </form>
  </div>
  <div id="server" class="hidden">
  <form action="{% url web.views.add_task %}" method="post">{%csrf_token%}
   <label for="id_job_type">Job:</label>
   {{ server_form.job_type }}
   <input type="hidden", name="site_id" value="{{site_id}}"/>
   <button type="submit">Create Server Job</button>
  </form>
  </div>
</div>
{%endif %}
<hr/>
<button id="view_job" type="button">Jobs</button>
<button id="view_category" type="button">Category</button>
<div id="jobs" class="hidden">
    {%if perms.web.edit_task %}
    <div id="add_job" >
        <button id="add_user_job" type="button">Add User Job</button>
        <button id="add_server_job" type="button">Add Server Job</button>
        <div id="user_job_div" class="hidden">
            <form id="user_job" action="{% url web.views.update_job %}" method="post">
                {% csrf_token %}
                <div id="id_name_div" />
                <input id="id_id" type="hidden" name="id" value="0"/>
                <label for="id_name">Name:</label>
                {{ job_form.name }}
                </div>
                <input type="hidden" name="type" value="3"/>
                <div id="id_category_div" />
                    <label for="id_category">Category:</label>
                    {{ job_form.category }}
                </div>
                <div id="id_description_div" />
                    <label for="id_description">Description:</label>
                    {{ job_form.description }}
                </div>
                <button type="submit">Update Job</button>
            </form>
        </div>
        <div id="server_job_div" class="hidden">
            <form id="user_job"  action="{% url web.views.update_job %}" method="post">
                <div id="id_name_div" />
                <input id="id_id" type="hidden" name="id" value="0"/>
                <label for="id_name">Name:</label>
                {{ job_form.name }}
                </div>
                <ul>
                    <li><input type="radio" name="type" value="1" checked="yes">SERVER 1-1</input></li>
                    <li><input type="radio" name="type" value="2">SERVER M-1</input></li>
                </ul>
                <div id="id_category_div" />
                    <label for="id_category">Category:</label>
                    {{ job_form.category }}
                </div>
                <div id="id_script_div" />
                    <label for="id_script">Script:</label>
                    {{ job_form.script }}
                </div>
                <div id="id_description_div" />
                    <label for="id_description">Description:</label>
                    {{ job_form.description }}
                </div>
                <button type="submit">Update Job</button>
            </form>
        </div>
    </div>

    {% endif %}
    <div id="job_view">
        <table>
            <tr>
                <th class="tl">Name</th>
                <th>Type</th>
                {%if perms.web.edit_task %}
                <th>Category</th>
                <th class="tr">Edit</th>
                {%else%}
                <th class="tr">Category</th>
                {%endif%}
            </tr>
        {% for job in jobs %}
            <tr>
                <td>{{ job.name }}</td>
                <td>{{ job.get_type_display }}</td>
                <td>{{ job.category.category_name  }}</td>
                {%if perms.web.edit_task %}
                <td><button type="button" onclick="populate_job({{job.id}})">Edit</button></td>
                {%endif%}
            </tr>
        {% endfor %}
        </table>
    </div>
</div>
<div id="category" class="hidden">
    {%if perms.web.edit_task %}
    <div id="add_category" >
        <button id="cat_but" type="button">Add Category</button>
        <div id="cat_div" class="hidden">
            <form id="add_category" action="{% url web.views.add_category %}" method="post">
                {% csrf_token %}
                {{ category_form.category_name }}
                <button type="submit">Add</button>
            </form>
        </div>
    </div>
    {% endif %}
    <div id="category_view">
        <table>
            <tr>
                <th class="tl tr">Name</th>
            </tr>
        {% for cat in categories %}
            <tr>
                <td>{{ cat.category_name }}</td>
            </tr>
        {% endfor %}
        </table>
    </div>
</div>

</div>

{% endblock %}
